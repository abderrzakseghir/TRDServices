@page "/simulation"
@using MockScoreService.Web.Data
@using MockScoreService.Web.Models
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@inject FootballDbContext DbContext
@inject ISnackbar Snackbar
@implements IDisposable



<PageTitle>Simulation Temps Réel</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Simulation Temps Réel</MudText>
<MudText Class="mb-4">Contrôlez les scores des matchs en cours en temps réel</MudText>

<MudGrid>
    @foreach (var match in _activeMatches)
    {
        <MudItem xs="12" md="6" lg="4">
            <MudCard Elevation="4">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">@match.HomeTeam.ShortName vs @match.AwayTeam.ShortName</MudText>
                        <MudText Typo="Typo.body2">@match.UtcDate.ToString("dd/MM/yyyy HH:mm")</MudText>
                    </CardHeaderContent>
                    <CardHeaderActions>
                        <MudChip Color="@GetStatusColor(match.Status)" Size="Size.Small">@match.Status</MudChip>
                    </CardHeaderActions>
                </MudCardHeader>
                <MudCardContent>
                    <!-- Équipe Domicile -->
                    <MudGrid>
                        <MudItem xs="8">
                            <MudText Typo="Typo.h6">@match.HomeTeam.Name</MudText>
                        </MudItem>
                        <MudItem xs="4" Class="d-flex justify-end align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.Remove" 
                                          Color="Color.Error" 
                                          Size="Size.Small" 
                                          OnClick="@(() => DecrementScore(match.Id, true))" 
                                          Disabled="@(match.HomeScore == 0 || match.Status != "IN_PLAY")" />
                            <MudText Typo="Typo.h4" Class="mx-2">@(match.HomeScore ?? 0)</MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                          Color="Color.Success" 
                                          Size="Size.Small" 
                                          OnClick="@(() => IncrementScore(match.Id, true))"
                                          Disabled="@(match.Status != "IN_PLAY")" />
                        </MudItem>
                    </MudGrid>

                    <MudDivider Class="my-2" />

                    <!-- Équipe Extérieur -->
                    <MudGrid>
                        <MudItem xs="8">
                            <MudText Typo="Typo.h6">@match.AwayTeam.Name</MudText>
                        </MudItem>
                        <MudItem xs="4" Class="d-flex justify-end align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.Remove" 
                                          Color="Color.Error" 
                                          Size="Size.Small" 
                                          OnClick="@(() => DecrementScore(match.Id, false))" 
                                          Disabled="@(match.AwayScore == 0 || match.Status != "IN_PLAY")" />
                            <MudText Typo="Typo.h4" Class="mx-2">@(match.AwayScore ?? 0)</MudText>
                            <MudIconButton Icon="@Icons.Material.Filled.Add" 
                                          Color="Color.Success" 
                                          Size="Size.Small" 
                                          OnClick="@(() => IncrementScore(match.Id, false))"
                                          Disabled="@(match.Status != "IN_PLAY")" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
                <MudCardActions>
                    @if (match.Status == "SCHEDULED")
                    {
                        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="@(() => StartMatch(match.Id))" StartIcon="@Icons.Material.Filled.PlayArrow">
                            Démarrer
                        </MudButton>
                    }
                    @if (match.Status == "IN_PLAY")
                    {
                        <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="@(() => FinishMatch(match.Id))" StartIcon="@Icons.Material.Filled.Stop">
                            Terminer
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" Color="Color.Info" OnClick="@(() => ResetScore(match.Id))" StartIcon="@Icons.Material.Filled.Refresh" Class="ml-2">
                            Reset
                        </MudButton>
                    }
                    @if (match.Status == "FINISHED")
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(() => RestartMatch(match.Id))" StartIcon="@Icons.Material.Filled.Replay">
                            Rejouer
                        </MudButton>
                    }
                </MudCardActions>
            </MudCard>
        </MudItem>
    }
</MudGrid>

@if (!_activeMatches.Any())
{
    <MudAlert Severity="Severity.Info" Class="mt-4">
        Aucun match disponible pour la simulation. <MudLink Href="/matches">Créer un match</MudLink>
    </MudAlert>
}

@code {
    private List<Match> _activeMatches = new();
    private System.Threading.Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        await LoadMatches();
        
        // Auto-refresh every 2 seconds
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadMatches();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(2));
    }

    private async Task LoadMatches()
    {
        _activeMatches = await DbContext.Matches
            .Include(m => m.HomeTeam)
            .Include(m => m.AwayTeam)
            .Where(m => m.Status == "SCHEDULED" || m.Status == "IN_PLAY" || m.Status == "FINISHED")
            .OrderBy(m => m.Status == "IN_PLAY" ? 0 : m.Status == "SCHEDULED" ? 1 : 2)
            .ThenBy(m => m.UtcDate)
            .ToListAsync();
    }

    private async Task StartMatch(int matchId)
    {
        var match = await DbContext.Matches.FindAsync(matchId);
        if (match != null)
        {
            match.Status = "IN_PLAY";
            match.HomeScore = 0;
            match.AwayScore = 0;
            match.LastUpdated = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            
            Snackbar.Add("Match démarré", Severity.Success);
            await LoadMatches();
        }
    }

    private async Task FinishMatch(int matchId)
    {
        var match = await DbContext.Matches.FindAsync(matchId);
        if (match != null)
        {
            match.Status = "FINISHED";
            match.HalfTimeHomeScore = (int)(match.HomeScore ?? 0) / 2;
            match.HalfTimeAwayScore = (int)(match.AwayScore ?? 0) / 2;
            match.LastUpdated = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            
            Snackbar.Add("Match terminé", Severity.Info);
            await LoadMatches();
        }
    }

    private async Task RestartMatch(int matchId)
    {
        var match = await DbContext.Matches.FindAsync(matchId);
        if (match != null)
        {
            match.Status = "SCHEDULED";
            match.HomeScore = null;
            match.AwayScore = null;
            match.HalfTimeHomeScore = null;
            match.HalfTimeAwayScore = null;
            match.LastUpdated = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            
            Snackbar.Add("Match réinitialisé", Severity.Info);
            await LoadMatches();
        }
    }

    private async Task IncrementScore(int matchId, bool isHome)
    {
        var match = await DbContext.Matches.FindAsync(matchId);
        if (match != null && match.Status == "IN_PLAY")
        {
            if (isHome)
            {
                match.HomeScore = (match.HomeScore ?? 0) + 1;
            }
            else
            {
                match.AwayScore = (match.AwayScore ?? 0) + 1;
            }
            match.LastUpdated = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            await LoadMatches();
        }
    }

    private async Task DecrementScore(int matchId, bool isHome)
    {
        var match = await DbContext.Matches.FindAsync(matchId);
        if (match != null && match.Status == "IN_PLAY")
        {
            if (isHome && match.HomeScore > 0)
            {
                match.HomeScore = (match.HomeScore ?? 0) - 1;
            }
            else if (!isHome && match.AwayScore > 0)
            {
                match.AwayScore = (match.AwayScore ?? 0) - 1;
            }
            match.LastUpdated = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            await LoadMatches();
        }
    }

    private async Task ResetScore(int matchId)
    {
        var match = await DbContext.Matches.FindAsync(matchId);
        if (match != null)
        {
            match.HomeScore = 0;
            match.AwayScore = 0;
            match.LastUpdated = DateTime.UtcNow;
            await DbContext.SaveChangesAsync();
            
            Snackbar.Add("Scores remis à zéro", Severity.Info);
            await LoadMatches();
        }
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "SCHEDULED" => Color.Info,
            "IN_PLAY" => Color.Success,
            "FINISHED" => Color.Default,
            _ => Color.Default
        };
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
