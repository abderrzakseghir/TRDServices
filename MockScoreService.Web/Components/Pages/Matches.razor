@page "/matches"
@using MockScoreService.Web.Data
@using MockScoreService.Web.Models
@using Microsoft.EntityFrameworkCore
@using MudBlazor
@inject FootballDbContext DbContext
@inject ISnackbar Snackbar



<PageTitle>Gestion des Matchs</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">Gestion des Matchs</MudText>

<MudPaper Class="pa-4 mb-4">
    <MudText Typo="Typo.h5" GutterBottom="true">Créer un Nouveau Match</MudText>
    <MudGrid>
        <MudItem xs="12" md="6">
            <MudSelect T="int" @bind-Value="_selectedHomeTeamId" Label="Équipe Domicile" Variant="Variant.Outlined">
                @foreach (var team in _teams)
                {
                    <MudSelectItem Value="@team.Id">@team.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="6">
            <MudSelect T="int" @bind-Value="_selectedAwayTeamId" Label="Équipe Extérieur" Variant="Variant.Outlined">
                @foreach (var team in _teams)
                {
                    <MudSelectItem Value="@team.Id">@team.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudDatePicker @bind-Date:get="_matchDate" @bind-Date:set="(v => _matchDate = v)" Label="Date du Match" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12" md="6">
            <MudTimePicker @bind-Time:get="_matchTime" @bind-Time:set="(v => _matchTime = v)" Label="Heure du Match" Variant="Variant.Outlined" />
        </MudItem>

        <MudItem xs="12">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateMatch" StartIcon="@Icons.Material.Filled.Add">
                Créer le Match
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudTable Items="@_matches" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>ID</MudTh>
        <MudTh>Date</MudTh>
        <MudTh>Équipe Domicile</MudTh>
        <MudTh>Score</MudTh>
        <MudTh>Équipe Extérieur</MudTh>
        <MudTh>Statut</MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="ID">@context.Id</MudTd>
        <MudTd DataLabel="Date">@context.UtcDate.ToString("dd/MM/yyyy HH:mm")</MudTd>
        <MudTd DataLabel="Domicile">@context.HomeTeam.ShortName</MudTd>
        <MudTd DataLabel="Score">
            @if (context.HomeScore.HasValue && context.AwayScore.HasValue)
            {
                <strong>@context.HomeScore - @context.AwayScore</strong>
            }
            else
            {
                <span>-</span>
            }
        </MudTd>
        <MudTd DataLabel="Extérieur">@context.AwayTeam.ShortName</MudTd>
        <MudTd DataLabel="Statut">
            <MudChip Color="@GetStatusColor(context.Status)" Size="Size.Small">@context.Status</MudChip>
        </MudTd>
        <MudTd DataLabel="Actions">
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteMatch(context.Id))" />
        </MudTd>
    </RowTemplate>
</MudTable>

@code {
private List<Match> _matches = new();
private List<Team> _teams = new();
private bool _loading = true;
    
private int _selectedHomeTeamId;
private int _selectedAwayTeamId;
private DateTime? _matchDate = DateTime.Now.AddDays(1);
private TimeSpan? _matchTime = new TimeSpan(20, 0, 0);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _teams = await DbContext.Teams.ToListAsync();
        _matches = await DbContext.Matches
            .Include(m => m.HomeTeam)
            .Include(m => m.AwayTeam)
            .OrderBy(m => m.UtcDate)
            .ToListAsync();
        _loading = false;
    }

    private async Task CreateMatch()
    {
        if (_selectedHomeTeamId == 0 || _selectedAwayTeamId == 0 || !_matchDate.HasValue || !_matchTime.HasValue)
        {
            Snackbar.Add("Veuillez remplir tous les champs", Severity.Warning);
            return;
        }

        if (_selectedHomeTeamId == _selectedAwayTeamId)
        {
            Snackbar.Add("Les équipes doivent être différentes", Severity.Error);
            return;
        }

        var matchDateTime = _matchDate.Value.Date + _matchTime.Value;
        
        var match = new Match
        {
            CompetitionId = 1,
            SeasonId = 1,
            HomeTeamId = _selectedHomeTeamId,
            AwayTeamId = _selectedAwayTeamId,
            UtcDate = matchDateTime.ToUniversalTime(),
            Status = "SCHEDULED",
            Matchday = 20,
            Stage = "REGULAR_SEASON",
            LastUpdated = DateTime.UtcNow
        };

        DbContext.Matches.Add(match);
        await DbContext.SaveChangesAsync();
        
        Snackbar.Add("Match créé avec succès", Severity.Success);
        
        _selectedHomeTeamId = 0;
        _selectedAwayTeamId = 0;
        
        await LoadData();
    }


    private async Task DeleteMatch(int matchId)
    {
        var match = await DbContext.Matches.FindAsync(matchId);
        if (match != null)
        {
            DbContext.Matches.Remove(match);
            await DbContext.SaveChangesAsync();
            Snackbar.Add("Match supprimé", Severity.Success);
            await LoadData();
        }
    }

    private Color GetStatusColor(string status)
    {
        return status switch
        {
            "SCHEDULED" => Color.Info,
            "IN_PLAY" => Color.Success,
            "FINISHED" => Color.Default,
            _ => Color.Default
        };
    }
}
